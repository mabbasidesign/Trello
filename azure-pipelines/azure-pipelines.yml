trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - src/**
      - docker/**
      - azure-pipelines.yml

pr:
  branches:
    include:
      - main
      - develop

variables:
  # Build Configuration
  buildConfiguration: 'Release'
  dotnetVersion: '10.0.x'
  
  # Docker Configuration
  dockerRegistryServiceConnection: 'TrelloDockerRegistry' # Update with your service connection name
  imageRepository: 'trello-microservices'
  containerRegistry: 'trelloacr.azurecr.io' # Update with your ACR name
  dockerfilePath: '$(Build.SourcesDirectory)'
  tag: '$(Build.BuildId)'
  
  # Azure Resources
  azureSubscription: 'TrelloAzureSubscription' # Update with your service connection name
  resourceGroupName: 'rg-trello-microservices'
  location: 'eastus'

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildServices
        displayName: 'Build .NET Services'
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - task: UseDotNet@2
            displayName: 'Install .NET SDK'
            inputs:
              packageType: 'sdk'
              version: $(dotnetVersion)
              includePreviewVersions: false
          
          - task: DotNetCoreCLI@2
            displayName: 'Restore Product Service'
            inputs:
              command: 'restore'
              projects: 'src/product-service/product-service.csproj'
          
          - task: DotNetCoreCLI@2
            displayName: 'Restore Order Service'
            inputs:
              command: 'restore'
              projects: 'src/order-service/order-service.csproj'
          
          - task: DotNetCoreCLI@2
            displayName: 'Build Product Service'
            inputs:
              command: 'build'
              projects: 'src/product-service/product-service.csproj'
              arguments: '--configuration $(buildConfiguration) --no-restore'
          
          - task: DotNetCoreCLI@2
            displayName: 'Build Order Service'
            inputs:
              command: 'build'
              projects: 'src/order-service/order-service.csproj'
              arguments: '--configuration $(buildConfiguration) --no-restore'
          
          # Uncomment when you have tests
          # - task: DotNetCoreCLI@2
          #   displayName: 'Run Tests'
          #   inputs:
          #     command: 'test'
          #     projects: '**/*Tests.csproj'
          #     arguments: '--configuration $(buildConfiguration) --no-build --collect:"XPlat Code Coverage"'
          
          - task: PublishCodeCoverageResults@1
            displayName: 'Publish Code Coverage'
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(Agent.TempDirectory)/**/*coverage.cobertura.xml'

  - stage: BuildDockerImages
    displayName: 'Build Docker Images'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: BuildAndPushImages
        displayName: 'Build and Push Docker Images'
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - task: Docker@2
            displayName: 'Build Product Service Image'
            inputs:
              command: 'build'
              repository: '$(imageRepository)-product'
              dockerfile: 'src/product-service/Dockerfile'
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
                latest
              buildContext: '$(Build.SourcesDirectory)/src/product-service'
          
          - task: Docker@2
            displayName: 'Push Product Service Image'
            inputs:
              command: 'push'
              repository: '$(imageRepository)-product'
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
                latest
          
          - task: Docker@2
            displayName: 'Build Order Service Image'
            inputs:
              command: 'build'
              repository: '$(imageRepository)-order'
              dockerfile: 'src/order-service/Dockerfile'
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
                latest
              buildContext: '$(Build.SourcesDirectory)/src/order-service'
          
          - task: Docker@2
            displayName: 'Push Order Service Image'
            inputs:
              command: 'push'
              repository: '$(imageRepository)-order'
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
                latest

  - stage: DeployInfrastructure
    displayName: 'Deploy Azure Infrastructure'
    dependsOn: BuildDockerImages
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: DeployBicep
        displayName: 'Deploy Bicep Templates'
        pool:
          vmImage: 'ubuntu-latest'
        
        steps:
          - task: AzureCLI@2
            displayName: 'Deploy Infrastructure'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az deployment sub create \
                  --location $(location) \
                  --template-file $(Build.SourcesDirectory)/infra/main.bicep \
                  --parameters environment=prod \
                  --name "deployment-$(Build.BuildId)"

  - stage: DeployServices
    displayName: 'Deploy Services'
    dependsOn: DeployInfrastructure
    condition: succeeded()
    jobs:
      - deployment: DeployToAppService
        displayName: 'Deploy to Azure App Service'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebAppContainer@1
                  displayName: 'Deploy Product Service'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    appName: 'app-trello-product-prod' # Update with your app name
                    containers: '$(containerRegistry)/$(imageRepository)-product:$(tag)'
                
                - task: AzureWebAppContainer@1
                  displayName: 'Deploy Order Service'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    appName: 'app-trello-order-prod' # Update with your app name
                    containers: '$(containerRegistry)/$(imageRepository)-order:$(tag)'
